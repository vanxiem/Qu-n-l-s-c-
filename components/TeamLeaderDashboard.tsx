
import React, { useState } from 'react';
import { Machine, DowntimeEvent, MachineStatus, MachineBrand, MachineType } from '../types';

interface TeamLeaderDashboardProps {
  machines: Machine[];
  events: DowntimeEvent[];
  onUpdateStatus: (machineId: string, status: MachineStatus, reason?: string) => void;
  onUpdateMachine: (machineId: string, updates: Partial<Machine>) => void;
}

const TeamLeaderDashboard: React.FC<TeamLeaderDashboardProps> = ({ machines, events, onUpdateStatus, onUpdateMachine }) => {
  const [editingMachine, setEditingMachine] = useState<Machine | null>(null);
  const [newCode, setNewCode] = useState('');
  const [newBrand, setNewBrand] = useState<MachineBrand>(MachineBrand.CLF);
  const [newType, setNewType] = useState<MachineType>(MachineType.INJECTION);
  const [newCapacity, setNewCapacity] = useState<number>(0);

  const openEditModal = (machine: Machine) => {
    setEditingMachine(machine);
    setNewCode(machine.code);
    setNewBrand(machine.brand);
    setNewType(machine.type);
    setNewCapacity(machine.capacity);
  };

  const handleSave = () => {
    if (editingMachine && newCode.trim()) {
      onUpdateMachine(editingMachine.id, {
        code: newCode.trim(),
        brand: newBrand,
        type: newType,
        capacity: newCapacity
      });
      setEditingMachine(null);
    }
  };

  return (
    <div className="space-y-6">
      <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div className="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
          <h3 className="font-bold text-slate-800 uppercase">B·∫£ng ƒêi·ªÅu Ph·ªëi C·ªßa Tr∆∞·ªüng Ca</h3>
          <div className="text-xs font-medium text-slate-500 italic">* Qu·∫£n l√Ω danh s√°ch thi·∫øt b·ªã v√† tr·∫°ng th√°i v·∫≠n h√†nh</div>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-left">
            <thead className="bg-slate-50 text-slate-400 text-xs font-bold uppercase tracking-wider">
              <tr>
                <th className="px-6 py-4">M√£ M√°y</th>
                <th className="px-6 py-4">C·∫•u H√¨nh</th>
                <th className="px-6 py-4">Tr·∫°ng Th√°i</th>
                <th className="px-6 py-4">L√Ω Do D·ª´ng</th>
                <th className="px-6 py-4">Th·ªùi Gian</th>
                <th className="px-6 py-4">Thao T√°c</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {machines.map(machine => {
                const activeEvent = events.find(e => e.machineId === machine.id && !e.endTime);
                let duration = '0m';
                if (activeEvent) {
                  const diff = Math.floor((Date.now() - activeEvent.startTime) / 60000);
                  duration = `${diff}m`;
                }

                return (
                  <tr key={machine.id} className="hover:bg-slate-50 transition-colors">
                    <td className="px-6 py-4">
                      <div className="flex items-center gap-2">
                        <div className="font-black text-slate-800 text-lg">{machine.code}</div>
                        <button 
                          onClick={() => openEditModal(machine)}
                          className="p-1 hover:bg-blue-50 text-blue-400 hover:text-blue-600 rounded transition-colors"
                        >
                          ‚úèÔ∏è
                        </button>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                       <div className="flex flex-col gap-1">
                          <span className={`w-fit px-2 py-0.5 rounded text-[9px] font-black ${machine.type === MachineType.INJECTION ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}`}>
                            {machine.type === MachineType.INJECTION ? 'M√ÅY √âP' : 'M√ÅY TH·ªîI'}
                          </span>
                          <span className="text-sm font-bold text-slate-600">{machine.brand} - {machine.capacity}T</span>
                       </div>
                    </td>
                    <td className="px-6 py-4">
                      <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase ${
                        machine.status === MachineStatus.RUNNING 
                        ? 'bg-green-100 text-green-700' 
                        : 'bg-red-100 text-red-700'
                      }`}>
                        {machine.status === MachineStatus.RUNNING ? 'Ch·∫°y' : 'D·ª´ng'}
                      </span>
                    </td>
                    <td className="px-6 py-4 text-sm text-slate-600 font-medium">
                      {machine.currentDowntimeReason || '-'}
                    </td>
                    <td className="px-6 py-4 text-sm font-mono font-bold text-slate-700">
                      {machine.status === MachineStatus.STOPPED ? duration : '-'}
                    </td>
                    <td className="px-6 py-4">
                      <button className="p-2 hover:bg-slate-100 rounded-lg transition-all text-lg">üïí</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>

      {editingMachine && (
        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-3xl w-full max-w-md shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
            <div className="p-6 border-b border-slate-100 bg-slate-50">
              <h3 className="text-xl font-black text-slate-800">Hi·ªáu ch·ªânh m√°y</h3>
              <p className="text-slate-500 text-sm font-medium">Tr∆∞·ªüng ca c·∫≠p nh·∫≠t th√¥ng tin thi·∫øt b·ªã</p>
            </div>
            <div className="p-6 space-y-6">
              <div>
                <label className="block text-xs font-black text-slate-400 uppercase mb-2 tracking-widest">M√£ M√°y (Code)</label>
                <input 
                  type="text" 
                  className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg text-slate-700"
                  value={newCode}
                  onChange={(e) => setNewCode(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-xs font-black text-slate-400 uppercase mb-2 tracking-widest">T·∫£i Tr·ªçng (T·∫•n)</label>
                <input 
                  type="number" 
                  className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none font-bold text-slate-700"
                  value={newCapacity}
                  onChange={(e) => setNewCapacity(Number(e.target.value))}
                />
              </div>
            </div>
            <div className="p-6 border-t border-slate-100 bg-slate-50 flex gap-3">
              <button onClick={() => setEditingMachine(null)} className="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-bold hover:bg-slate-50 transition-all">H·ªßy</button>
              <button onClick={handleSave} className="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-black shadow-lg transition-all">L∆∞u</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default TeamLeaderDashboard;
